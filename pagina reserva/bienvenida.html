<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock&Go - Reserva de Casilleros</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <img src="../Imagenes/image-removebg-preview.png" alt="Lock&Go">
            <span class="logo-text">Lock&Go</span>
        </div>
        <ul class="menu">
            <li><a href="../Pagina index/index.html">Inicio</a></li>
            <li><a href="../Pagina Reserva/bienvenida.html">Casilleros</a></li>
            <li><a href="../contactenos/contacto.html">Contacto</a></li>
        </ul>
        <div class="user-icon">
            <a href="../login/inicioSesion_usuario.html"><img src="../Imagenes/perfil.png" alt="Perfil"></a>
        </div>
    </nav>

    <section class="tittle-welcome">
        <h2>Por favor selecciona el casillero que mejor se te facilite</h2>
    </section>

    <section class="contenedor-botones">
        <button class="btn bloque" data-bloque="A">Bloque A</button>
        <button class="btn bloque" data-bloque="B">Bloque B</button>
        <button class="btn bloque" data-bloque="C">Bloque C</button>
        <button class="btn bloque" data-bloque="D">Bloque D</button>
        <button class="btn bloque" data-bloque="E">Bloque E</button>
    </section>

    <div class="contenedor-cuadricula" id="cuadricula"></div>

    <!-- Ventana emergente para la reserva -->
    <div id="ventanaEmergente" class="ventana">
        <div class="contenido-ventana">
            <h3>Reservar Casillero</h3>
            <p>¿Deseas reservar el casillero <span id="numeroCasillero"></span>?</p>
            <form id="formReservar">
                <input type="hidden" id="casilleroIdInput" name="casillero_id">
                <input type="hidden" id="estudianteIdInput" name="estudiante_id">
                <button type="submit" id="reservarButton">Reservar Casillero</button>
                <button type="button" id="cerrarButton" onclick="cerrarVentanaEmergente()">Cerrar</button>
            </form>
        </div>
    </div>

    <script>
       
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('../login/obtener_usuario.php'); // Ajusta la ruta según tu estructura de carpetas
            const data = await response.json();

            if (data.id_usuario) {
                document.getElementById('estudianteIdInput').value = data.id_usuario;
            }
        } catch (error) {
            console.error('Error obteniendo el usuario:', error);
        }
    });


        async function obtenerCasillerosOcupados() {
            try {
                const respuesta = await fetch('obtener_casilleros.php');
                const datos = await respuesta.json();
                return datos.ocupados || [];
            } catch (error) {
                console.error('Error obteniendo casilleros ocupados:', error);
                return [];
            }
        }

        document.querySelectorAll('.btn.bloque').forEach(button => {
            button.addEventListener('click', async function () {
                const bloque = this.getAttribute('data-bloque');
                const cuadricula = document.getElementById('cuadricula');
                cuadricula.innerHTML = '';

                let numeros = [];

                // Asignamos los rangos correspondientes a cada bloque
                if (bloque === 'A') {
                    numeros = Array.from({ length: 120 }, (_, i) => i + 1); // De 1 a 120
                } else if (bloque === 'B') {
                    numeros = Array.from({ length: 149 }, (_, i) => i + 121); // 121 a 269
                } else if (bloque === 'C') {
                    numeros = [
                        ...Array.from({ length: 15 }, (_, i) => i + 270), // de 270 a 284
                        ...Array.from({ length: 7 }, (_, i) => i + 304), // de 304 a 310
                        ...Array.from({ length: 11 }, (_, i) => i + 315), // 315 a 325
                        ...Array.from({ length: 11 }, (_, i) => i + 330), // 330 a 340
                    ];
                } else if (bloque === 'D') {
                    numeros = [
                        ...Array.from({ length: 15 }, (_, i) => i + 285), // 285 a 299
                        ...Array.from({ length: 75 }, (_, i) => i + 360), // 360 a 434
                    ];
                } else if (bloque === 'E') {
                    numeros = Array.from({ length: 41 }, (_, i) => i + 435); // de 435 a 475
                }
 
                const ocupados = await obtenerCasillerosOcupados();

                numeros.forEach(num => {
                    const celda = document.createElement('div');
                    celda.classList.add('celda');
                    celda.textContent = num;

                    if (ocupados.includes(num)) {
                        celda.classList.add('ocupado');
                    } else {
                        celda.addEventListener('click', function () {
                            mostrarVentanaEmergente(num);
                        });
                    }

                    cuadricula.appendChild(celda);
                });

                cuadricula.classList.toggle('visible');
            });
        });

        function mostrarVentanaEmergente(numCasillero) {
            document.getElementById('numeroCasillero').textContent = numCasillero;
            document.getElementById('casilleroIdInput').value = numCasillero;
            document.getElementById('ventanaEmergente').style.display = 'flex';
        }

        function cerrarVentanaEmergente() {
            document.getElementById('ventanaEmergente').style.display = 'none';
        }

        document.getElementById('formReservar').addEventListener('submit', async function (event) {
            event.preventDefault();

            const casilleroId = document.getElementById('casilleroIdInput').value;
            const estudianteId = document.getElementById('estudianteIdInput').value;

            try {
                const respuesta = await fetch('reservar_casillero.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ casillero_id: casilleroId, estudiante_id: estudianteId })
                });

                const resultado = await respuesta.json();

                if (resultado.success) {
                    alert('Reserva realizada con éxito');
                    cerrarVentanaEmergente();
                    location.reload(); // Recargar la página para reflejar los cambios
                } else {
                    alert(resultado.error || 'Error al reservar casillero');
                }
            } catch (error) {
                console.error('Error en la reserva:', error);
                alert('Error al conectar con el servidor');
            }
        });
    </script>

</body>

</html>
