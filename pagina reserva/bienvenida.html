<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lock&Go - Reserva de Casilleros</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="logo">
            <img src="../Imagenes/image-removebg-preview.png" alt="Lock&Go">
            <span class="logo-text">Lock&Go</span>
        </div>
        <ul class="menu">
            <li><a href="../Pagina index/index.html">Inicio</a></li>
            <li><a href="../Pagina Reserva/bienvenida.html">Casilleros</a></li>
            <li><a href="../contactenos/contacto.html">Contacto</a></li>
        </ul>
        <div class="user-icon">
            <a href="../login/inicioSesion_usuario.html"><img src="../Imagenes/perfil.png" alt="Perfil"></a>
        </div>
    </nav>

    <section class="tittle-welcome">
        <h2>Por favor selecciona el casillero que mejor se te facilite</h2>
    </section>

    <section class="contenedor-botones">
        <button class="btn bloque" data-bloque="A">Bloque A</button>
        <button class="btn bloque" data-bloque="B">Bloque B</button>
        <button class="btn bloque" data-bloque="C">Bloque C</button>
        <button class="btn bloque" data-bloque="D">Bloque D</button>
        <button class="btn bloque" data-bloque="E">Bloque E</button>
    </section>

    <div class="contenedor-cuadricula" id="cuadricula"></div>

    <!-- Ventana emergente para la reserva -->
    <div id="ventanaEmergente" class="ventana">
        <div class="contenido-ventana">
            <h3>Reservar Casillero</h3>
            <p>¿Deseas reservar el casillero <span id="numeroCasillero"></span>?</p>
            <form id="formReservar">
                <input type="hidden" id="casilleroIdInput" name="casillero_id">
                <input type="hidden" id="estudianteIdInput" name="estudiante_id">
                <button type="submit" id="reservarButton">Reservar Casillero</button>
                <button type="button" id="cerrarButton" onclick="cerrarVentanaEmergente()">Cerrar</button>
            </form>
        </div>
    </div>

    <script>
        let estudianteId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('../login/obtener_usuario.php'); 
                const data = await response.json();

                if (data.id_usuario) {
                    estudianteId = data.id_usuario;
                    document.getElementById('estudianteIdInput').value = estudianteId;
                }
            } catch (error) {
                console.error('Error obteniendo el usuario:', error);
            }
        });

        async function obtenerCasillerosOcupados() {
            try {
                const respuesta = await fetch('obtener_casilleros.php');
                const datos = await respuesta.json();
                return datos.ocupados || [];
            } catch (error) {
                console.error('Error obteniendo casilleros ocupados:', error);
                return [];
            }
        }

        document.querySelectorAll('.btn.bloque').forEach(button => {
            button.addEventListener('click', async function () {
                const bloque = this.getAttribute('data-bloque');
                const cuadricula = document.getElementById('cuadricula');
                cuadricula.innerHTML = '';

                let numeros = [];

                switch (bloque) {
                    case 'A': numeros = [...Array(120).keys()].map(i => i + 1); break;
                    case 'B': numeros = [...Array(149).keys()].map(i => i + 121); break;
                    case 'C': numeros = [...Array(15).keys()].map(i => i + 270)
                                    .concat([...Array(7).keys()].map(i => i + 304))
                                    .concat([...Array(11).keys()].map(i => i + 315))
                                    .concat([...Array(11).keys()].map(i => i + 330));
                                    break;
                    case 'D': numeros = [...Array(15).keys()].map(i => i + 285)
                                    .concat([...Array(75).keys()].map(i => i + 360));
                                    break;
                    case 'E': numeros = [...Array(41).keys()].map(i => i + 435); break;
                }

                const ocupados = await obtenerCasillerosOcupados();

                numeros.forEach(num => {
                    const celda = document.createElement('div');
                    celda.classList.add('celda');
                    celda.textContent = num;

                    if (ocupados.includes(num)) {
                        celda.classList.add('ocupado');
                    } else {
                        celda.addEventListener('click', function () {
                            mostrarVentanaEmergente(num);
                        });
                    }

                    cuadricula.appendChild(celda);
                });

                cuadricula.classList.toggle('visible');
            });
        });

        function mostrarVentanaEmergente(numCasillero) {
            document.getElementById('numeroCasillero').textContent = numCasillero;
            document.getElementById('casilleroIdInput').value = numCasillero;
            document.getElementById('ventanaEmergente').style.display = 'flex';
        }

        function cerrarVentanaEmergente() {
            document.getElementById('ventanaEmergente').style.display = 'none';
        }

        document.getElementById('formReservar').addEventListener('submit', async function (event) {
            event.preventDefault();

            const casilleroId = document.getElementById('casilleroIdInput').value;
            if (!estudianteId) {
                alert('Error: No se ha identificado al usuario.');
                return;
            }

            try {
                const respuesta = await fetch('reservar_casillero.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ casillero_id: casilleroId })
                });

                const resultado = await respuesta.json();

                if (resultado.success) {
                    alert('Reserva realizada con éxito');
                    cerrarVentanaEmergente();
                    location.reload(); 
                } else {
                    alert(resultado.error || 'Error al reservar casillero');
                }
            } catch (error) {
                console.error('Error en la reserva:', error);
                alert('Error al conectar con el servidor');
            }
        });
    </script>

</body>
</html>
